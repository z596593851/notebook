# 事务的ACID属性
原子性，一致性，隔离性，持久性

# 事务的隔离级别
读未提交，读已提交，可重复读，可串行化

| 隔离级别 | 脏读（Dirty Read） | 不可重复读（NonRepeatable Read） | 幻读（Phantom Read） |
| --- | --- | --- | --- |
| 未提交读（Read uncommitted） | 可能 | 可能 | 可能 |
| 已提交读（Read committed） | 不可能 | 可能 | 可能 |
| 可重复读（Repeatable read） | 不可能 | 不可能 | 可能 |
| 可串行化（Serializable ） | 不可能 | 不可能 | 不可能 |

* 不可重复读：是指在数据库访问中，一个事务范围内两个相同的查询却返回了不同数据。这是由于查询时系统中其他事务修改的提交而引起的。比如事务T1读取某一数据，事务T2读取并修改了该数据，T1为了对读取值进行检验而再次读取该数据，便得到了不同的结果。  
* 幻读：是指事务A读取与搜索条件相匹配的若干行。事务B以插入或删除行等方式来修改事务A的结果集，事务A再次以相同条件搜索时发现结果集数量发生了变化。  

大致的区别在于不可重复读是由于另一个事务对数据的更改所造成的，而幻读是由于另一个事务插入或删除引起的。

# MVCC
MVCC是靠undo log（回滚日志）实现的，当事务对数据进行修改后，mysql会保存修改前的回滚日志，并用两个隐藏字段trx_id（当前事务id）和roll_pointer（上一版本的事务id）把这些undo日志串联起来形成一个历史记录版本链。

在可重复读隔离级别，当事务开启，执行任何查询sql时会生成当前事务的一致性视图read-view，该视图在事务结束之前都不会变化（如果是读已提交隔离级别在每次执行查询sql时都会重新生成），这个视图由执行查询时所有未提交事务id组成，同时还会记录read-view中的最小事务id（min_id），和当前所有事务中的最大事务id（max_id），事务里的任何sql查询结果都需要从对应undo版本链里的最新事务id开始逐条跟read-view做比对，如果该事务id小于min_id，说明该事务已经提交，可见；如果大于max_id，说明该事务是未来开始的，不可见；如果该事务id存在于read-view中，不可见；否则可见。

![[Pasted image 20220128222553.png]]

![[Pasted image 20220128222301.png]]
