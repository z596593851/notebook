# 锁
锁分为乐观锁和悲观锁，读写锁属于悲观锁，读读共享读写互斥；从锁粒度上又分为表锁和行锁。

MyISAM在执行查询语句SELECT前，会自动给涉及的所有表加读锁，在执行update、insert、delete操作会自动给涉及的表加写锁。
InnoDB在执行查询语句SELECT时(非串行隔离级别)，不会加锁。但是update、insert、delete操作会加行锁。

在可串行化的隔离级别下，select会加读锁，insert、update会对操锁的数据加写锁（行锁）

## Next-key Lock
![[Pasted image 20220128161250.png]]

对于这张表，空隙有(3,10)，(10,20)，(20,正无穷) 这三个区间。

在Session_1下面执行 update account set name = 'zhuge' where id > 8 and id <18;

则其他Session没法在这个范围所包含的所有行记录以及行记录所在的间隙里插入或修改任何数据，即id在(3,20]区间都无法修改数据，注意最后那个20也是包含在内的。

所以 Next-key Lcok=Gap Lock+行锁。

间隙锁是在可重复读隔离级别下才会生效。

## 无索引行锁会升级为表锁

锁主要是加在索引上，如果对非索引字段更新，行锁可能会变表锁：

session1 执行：update account set balance = 800 where name = 'lilei';

session2 对该表任一行操作都会阻塞住


