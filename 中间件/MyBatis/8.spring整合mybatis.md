spring-mybatis.xml：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans 
                           http://www.springframework.org/schema/beans/spring-beans.xsd">
		<!-- -->
		<!-- mapper包扫描 -->
       <context:component-scan base-package="com.linkedbear.mybatis.mapper"/>

		<!-- 数据源 -->
       <bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
              <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
              <property name="url" value="jdbc:mysql://localhost:3306/mybatis?characterEncoding=utf8"/>
              <property name="username" value="root"/>
              <property name="password" value="123456"/>
       </bean>

		<!-- 事务管理器 -->
       <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
              <property name="dataSource" ref="dataSource"/>
       </bean>

       <tx:annotation-driven transaction-manager="transactionManager"/>


       <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
              <property name="dataSource" ref="dataSource"/>
              <!-- MyBatis全局配置文件 -->
              <property name="configLocation" value="classpath:mybatis-config.xml"/>
              <property name="typeAliasesPackage" value="com.linkedbear.mybatis.entity"/>
       </bean>

		<!-- 快速操作SqlSession的SqlSessionTemplate-->
       <bean id="sqlSessionTemplate" class="org.mybatis.spring.SqlSessionTemplate">
              <constructor-arg index="0" ref="sqlSessionFactory"/>
       </bean>

		<!-- 扫描 Mapper 接口的MapperScannerConfigurer-->
       <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
              <property name="basePackage" value="com.linkedbear.mybatis.mapper"/>
              <!-- 注意这里只能设置sqlSessionFactoryBeanName！！！ -->
              <property name="sqlSessionFactoryBeanName" value="sqlSessionFactory"/>
       </bean>

</beans>
```

spring-mybatis.xml：

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <settings>
        <setting name="logImpl" value="LOG4J"/>
        <setting name="cacheEnabled" value="true"/>
    </settings>

    <!--
    别名已在初始化SqlSessionFactory时指定
    <typeAliases>
        <package name="com.linkedbear.mybatis.entity"/>
    </typeAliases>
    -->
    
    <!--
    事务管理器、数据源由SpringFramework统一管控
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.jdbc.Driver"/>
                <property name="url" value="jdbc:mysql://localhost:3306/mybatis?characterEncoding=utf-8"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
            </dataSource>
        </environment>
    </environments>
    -->

    <mappers>
        <mapper resource="mapper/department.xml"/>
        <mapper resource="mapper/user.xml"/>
    </mappers>
</configuration>
```

使用：
```java
public class MyBatisSpringApplication {
    
    public static void main(String[] args) throws Exception {
        ClassPathXmlApplicationContext ctx = new ClassPathXmlApplicationContext("spring-mybatis.xml");
        
        DepartmentMapper departmentMapper = ctx.getBean(DepartmentMapper.class);
        List<Department> departmentList = departmentMapper.findAll();
        departmentList.forEach(System.out::println);
        
        ctx.close();
    }
}
```

# SqlSessionFactoryBean
创建SqlSessionFactory
```java
public class SqlSessionFactoryBean
        implements FactoryBean<SqlSessionFactory>, InitializingBean, ApplicationListener<ApplicationEvent> {

       public SqlSessionFactory getObject() throws Exception {
              if (this.sqlSessionFactory == null) {
                     afterPropertiesSet();
              }      
              return this.sqlSessionFactory;
       }


        afterPropertiesSet(){
              this.sqlSessionFactory = buildSqlSessionFactory();
        }

        buildSqlSessionFactory(){

              //configuration
              //处理插件、类型处理器
              //解析MyBatis全局配置文件
              //处理数据源和事务工厂
              //解析mapper.xml
        }

        onApplicationEvent(){
              //处理没处理好的
        }

}
```

# MapperScannerConfigurer
扫描mapper接口
```java
public class MapperScannerConfigurer
        implements BeanDefinitionRegistryPostProcessor, InitializingBean, ApplicationContextAware, BeanNameAware {

        postProcessBeanDefinitionRegistry(){
              //doScan 扫描mapper接口，注册成bd
        }


        processBeanDefinitions(){

              //往mapper的bd里set SqlSessionFactory和SqlSessionTemplate
              //后续spring生命周期就可以实例化这些MapperFactoryBean进而生成代理对象
        }

}
```