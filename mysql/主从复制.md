# 基于BinLog的Replication
-   速度快
-   从节点只读
-   异步复制、半同步复制、增强半同步复制
-   弱一致性（因为复制不同步）
-   master宕机，slaver不会自动升级成master

适用于价值不高的数据，如日志、帖子等。

[https://www.jianshu.com/p/faf0127f1cb2](https://www.jianshu.com/p/faf0127f1cb2)

异步复制：默认的复制策略，Master 处理事务过程中，将其写入 Binlog就会通知 Dump thread 线程处理，然后完成事务的提交，不会关心是否成功发送到任意一个slave 中。
![[Pasted image 20220428215306.png]]

半同步复制：Master 处理事务过程中，提交完事务后，必须等至少一个 Slave 将收到的 binlog 写入 relay log 返回 ack 才能继续执行处理用户的事务。相关配置
rpl_semi_sync_master_wait_point = AFTER_COMMIT
rpl_semi_sync_master_wait_for_slave_count =1 （最低必须收到多少个 slave 的 ack）
rpl_semi_sync_master_timeout = 100（等待ack 的超时时间）
![[Pasted image 20220428215234.png]]

增强半同步复制：增强半同步和半同步不同是，等待 ACK 时间不同
rpl_semi_sync_master_wait_point = AFTER_SYNC（唯一区别）
半同步的问题是因为等待 ACK 的点是Commit 之后，此时 Master 已经完成数据变更，用户已经可以看到最新数据，当Binlog 还未同步到 Slave 时，发生主从切换，那么此时从库是没有这个最新数据的，用户又看到老数据。增强半同步将等待 ACK 的点放在提交Commit 之前，此时数据还未被提交，外界看不到数据变更，此时如果发送主从切换，新库依然还是老数据，不存在数据不一致的问题。
![[Pasted image 20220428215133.png]]

  

# PXC
-   同步复制（真正意义上的同步） 
-   强一致性
-   任意节点读写
-   只支持InnoDB引擎
-   写入效率取决于最弱的那一台
-   所有表必须都有主键

适用于一致性要求较高的数据，如订单、账户、财务。

首先客户端先发起一个事务，该事务先在本地执行，执行完成之后就要发起对事务的提交操作了。在提交之前需要将产生的复制写集广播出去，然后获取到一个全局的事务ID号，一并传送到另一个节点上面。通过合并数据之后，发现没有冲突数据，执行apply\_cd和commit\_cb动作，否则就需要取消此次事务的操作。而当前server节点通过验证之后，执行提交操作，并返回OK，如果验证没通过，则执行回滚。当然在生产中至少要有3个节点的集群环境，如果其中一个节点没有验证通过，出现了数据冲突，那么此时采取的方式就是讲出现不一致的节点踢出集群环境，而且它自己会执行shutdown命令，自动关机。

# 主从复制的好处
- 在从服务器可以执行查询工作，降低主服务器压力；（主库写，从库读，降压）读写分离
- 在从服务器进行备份，避免备份期间影响主服务器服务；容灾
- 当主服务器出现问题时，可以切换到从服务器。提高可用性